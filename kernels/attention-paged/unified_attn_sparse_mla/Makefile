# Unified Attention Sparse MLA - HipKittens Kernel Makefile

GPU_TARGET ?= CDNA4
TARGET = sparse_mla_kernel
SRC = kernel.cpp

SMLA_KV_LORA_RANK ?= 512
SMLA_ROPE_RANK ?= 64
SMLA_NUM_Q_HEADS ?= 128
SMLA_BLOCK_M ?= 16
SMLA_TILE_SIZE ?= 32
SMLA_BLOCK_SIZE ?= 16
SMLA_TOPK ?= 256

CPPFLAGS += -DSMLA_KV_LORA_RANK=$(SMLA_KV_LORA_RANK)
CPPFLAGS += -DSMLA_ROPE_RANK=$(SMLA_ROPE_RANK)
CPPFLAGS += -DSMLA_NUM_Q_HEADS=$(SMLA_NUM_Q_HEADS)
CPPFLAGS += -DSMLA_BLOCK_M=$(SMLA_BLOCK_M)
CPPFLAGS += -DSMLA_TILE_SIZE=$(SMLA_TILE_SIZE)
CPPFLAGS += -DSMLA_BLOCK_SIZE=$(SMLA_BLOCK_SIZE)
CPPFLAGS += -DSMLA_TOPK=$(SMLA_TOPK)

ROCM_INSTALL_DIR := $(ROCM_PATH)
HIP_INCLUDE_DIR  := $(ROCM_INSTALL_DIR)/include/hip
HIPCXX ?= $(ROCM_INSTALL_DIR)/bin/hipcc

ifeq ($(GPU_TARGET),CDNA2)
HIPFLAGS += -DKITTENS_CDNA2 --offload-arch=gfx90a
else ifeq ($(GPU_TARGET),CDNA3)
HIPFLAGS += -DKITTENS_CDNA3 --offload-arch=gfx942
else ifeq ($(GPU_TARGET),CDNA4)
HIPFLAGS += -DKITTENS_CDNA4 --offload-arch=gfx950 -DHIP_ENABLE_WARP_SYNC_BUILTINS -ffast-math
endif

CXX_STD := c++20
ICXXFLAGS := -std=$(CXX_STD) -w
ICPPFLAGS := -I${THUNDERKITTENS_ROOT}/include -I$(HIP_INCLUDE_DIR)
ICPPFLAGS += $(CPPFLAGS)

all: $(TARGET)

$(TARGET): $(SRC)
	$(HIPCXX) $(SRC) $(HIPFLAGS) $(ICXXFLAGS) $(ICPPFLAGS) -o $(TARGET) -shared -fPIC

clean:
	rm -f $(TARGET) *.o *.so
